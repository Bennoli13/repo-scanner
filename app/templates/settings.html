{% extends "layout.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<h2 class="mb-4">Settings</h2>

<!-- Git Config Form -->
<h4>Add Git Config</h4>
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form id="addGitConfig">
      <div class="row g-3 mb-2">
        <div class="col-md-3">
          <label class="form-label" for="platform">Platform</label>
          <select class="form-select" id="platform" data-bs-toggle="tooltip" title="Select GitHub or GitLab">
            <option value="github">GitHub</option>
            <option value="gitlab">GitLab</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="label_name">Label Name</label>
          <input type="text" class="form-control" id="label_name" placeholder="e.g. Internal Tools" data-bs-toggle="tooltip" title="Used as product name in DefectDojo">
        </div>
        <div class="col-md-5">
          <label class="form-label" for="base_url">Base URL</label>
          <input type="text" class="form-control" id="base_url" placeholder="https://github.com" data-bs-toggle="tooltip" title="Base URL of Git host">
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label" for="username">Username</label>
          <input type="text" class="form-control" id="username" placeholder="e.g. git-bot" data-bs-toggle="tooltip" title="Used to authenticate with the token">
        </div>
        <div class="col-md-6">
          <label class="form-label" for="token">Access Token</label>
          <input type="text" class="form-control" id="token" placeholder="Paste personal access token" data-bs-toggle="tooltip" title="Stored securely and encrypted">
        </div>
        <div class="col-md-2 d-grid align-items-end">
          <button type="submit" class="btn btn-primary">Add</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Git Config List -->
<h5 class="mt-4">Git Configs</h5>
<ul class="list-group" id="gitConfigList">
  <!-- JS will populate this -->
</ul>

<hr>

<!-- DefectDojo Config -->
<h4 class="mt-5">DefectDojo Config</h4>
<form id="defectdojoForm">
  <div class="mb-3">
    <input type="text" class="form-control" id="dojo_url" placeholder="DefectDojo URL" value="{{ dojo.url or '' }}">
  </div>
  <div class="mb-3 position-relative">
    <input type="password" class="form-control" id="dojo_token" placeholder="DefectDojo Token" value="{{ dojo.token or '' }}">
    <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0" style="margin: 5px;" onclick="toggleToken()">üëÅÔ∏è</button>
  </div>
  <button class="btn btn-success">Save</button>
</form>


<!-- Scheduler Config -->
<hr>
<h4 class="mt-5">Scheduled Scans</h4>
<form id="scheduleForm" class="mb-4">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Git Source</label>
      <select id="schedule_source" class="form-select" required></select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Repository</label>
      <select id="schedule_repo" class="form-select"></select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Scanner</label>
      <select id="schedule_scanner" class="form-select">
        <option value="trufflehog">TruffleHog</option>
        <option value="trivy">Trivy</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Day</label>
      <select id="cron_day" class="form-select">
        <option value="*">Every day</option>
        <option value="mon">Monday</option>
        <option value="tue">Tuesday</option>
        <option value="wed">Wednesday</option>
        <option value="thu">Thursday</option>
        <option value="fri">Friday</option>
        <option value="sat">Saturday</option>
        <option value="sun">Sunday</option>
      </select>
    </div>
    
    <div class="col-md-2">
      <label class="form-label">Hour</label>
      <input type="number" id="cron_hour" class="form-control" min="0" max="23" value="9">
    </div>
    
    <div class="col-md-2">
      <label class="form-label">Minute</label>
      <input type="number" id="cron_minute" class="form-control" min="0" max="59" value="0">
    </div>
    <div class="col-md-2 d-grid align-items-end">
      <button type="submit" class="btn btn-primary">Add Schedule</button>
    </div>
  </div>
</form>

<table class="table table-bordered table-sm" id="scheduleTable">
  <thead>
    <tr>
      <th>Source</th><th>Repo</th><th>Scanner</th><th>Frequency</th><th>Last Run</th><th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


<!-- JS Script -->
<script>
  function toggleToken() {
    const input = document.getElementById("dojo_token");
    input.type = input.type === "password" ? "text" : "password";
  }

  async function loadConfigs() {
    const res = await fetch("/api/settings");
    const data = await res.json();
    const list = document.getElementById("gitConfigList");
    list.innerHTML = "";

    data.forEach(cfg => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <div>
          <strong>${cfg.platform}</strong> | <strong>[${cfg.label_name || "Unnamed"}]</strong><br>
          <small>${cfg.base_url}</small>
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteConfig(${cfg.id})">Delete</button>
      `;
      list.appendChild(li);
    });
  }

  async function deleteConfig(id) {
    if (!confirm("Delete this config?")) return;
    await fetch("/api/settings?id=" + id, { method: "DELETE" });
    loadConfigs();
  }

  document.getElementById("addGitConfig").addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      username: document.getElementById("username").value,
      platform: document.getElementById("platform").value,
      label_name: document.getElementById("label_name").value,
      base_url: document.getElementById("base_url").value,
      token: document.getElementById("token").value,
    };
    const res = await fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      document.getElementById("addGitConfig").reset();
      loadConfigs();
    } else {
      alert("Failed to add config");
    }
  });

  document.getElementById("defectdojoForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      url: document.getElementById("dojo_url").value,
      token: document.getElementById("dojo_token").value
    };
    const res = await fetch("/api/defectdojo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      alert("DefectDojo config updated!");
    } else {
      alert("Failed to save DefectDojo config.");
    }
  });
  loadConfigs();  // load list on page load

  // Activate Bootstrap tooltips
  document.addEventListener("DOMContentLoaded", function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
  });
</script>
<!-- JS for Scheduler -->
<script>
  async function loadGitSources() {
    const res = await fetch("/api/settings");
    const sources = await res.json();
    const srcSelect = document.getElementById("schedule_source");
    srcSelect.innerHTML = '<option value="">Select</option>';
    sources.forEach(src => {
      const opt = document.createElement("option");
      opt.value = src.id;
      opt.textContent = `${src.platform} - ${src.label_name}`;
      srcSelect.appendChild(opt);
    });
  }

  async function loadReposForSource(sourceId) {
    const repoSelect = document.getElementById("schedule_repo");
    repoSelect.innerHTML = '<option value="">All Repos</option>'; // support all
    if (!sourceId) return;
    const res = await fetch(`/api/repos/source/${sourceId}`);
    const repos = await res.json();
    repos.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.name;
      repoSelect.appendChild(opt);
    });
  }

  async function loadSchedules() {
    const res = await fetch("/api/schedule");
    const data = await res.json();
    const tbody = document.querySelector("#scheduleTable tbody");
    tbody.innerHTML = "";
    data.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.source_label}</td>
        <td>${s.repo_name}</td>
        <td>${s.scanner_name}</td>
        <td>${s.cron_minute} ${s.cron_hour} * * ${s.cron_day}</td>
        <td>${s.last_run || "-"}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteSchedule(${s.id})">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function deleteSchedule(id) {
    if (!confirm("Delete this scheduled scan?")) return;
    await fetch(`/api/schedule/${id}`, { method: "DELETE" });
    loadSchedules();
  }

  document.getElementById("scheduleForm").addEventListener("submit", async e => {
    e.preventDefault();
    const payload = {
      source_id: document.getElementById("schedule_source").value,
      repo_id: document.getElementById("schedule_repo").value,
      scanner_name: document.getElementById("schedule_scanner").value,
      cron_day: document.getElementById("cron_day").value,
      cron_hour: parseInt(document.getElementById("cron_hour").value),
      cron_minute: parseInt(document.getElementById("cron_minute").value)
    };
    const res = await fetch("/api/schedule", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      document.getElementById("scheduleForm").reset();
      loadSchedules();
    } else {
      alert("Failed to create schedule");
    }
  });

  document.getElementById("schedule_source").addEventListener("change", e => {
    loadReposForSource(e.target.value);
  });

  // Load sources and existing schedules
  loadGitSources();
  loadSchedules();
</script>
{% endblock %}
